// src/plugins/rwdImageMaps.min.js
// Vanilla rwdImageMaps -> Global: rwdImg()
// - img[usemap]에 연결된 <map><area coords>를 반응형으로 재계산
// - 원본 coords는 data-rwd-coords에 1회 저장
// 사용:
//   rwdImg();                          // 문서 전체 img[usemap]
//   rwdImg('img[usemap]');             // selector
//   rwdImg(document.querySelectorAll('img[usemap]')); // NodeList/Array
// 반환값: destroy() (resize 리스너 해제)

(function (w, d) {
  'use strict';

  function debounce(fn, wait) {
    var t = null;
    return function () {
      var ctx = this,
        args = arguments;
      clearTimeout(t);
      t = setTimeout(function () {
        fn.apply(ctx, args);
      }, wait);
    };
  }

  function parseCoords(str) {
    return String(str || '')
      .split(',')
      .map(function (s) {
        return s.trim();
      })
      .filter(Boolean)
      .map(function (n) {
        return Number(n);
      });
  }

  function getMapName(usemapValue) {
    return String(usemapValue || '')
      .replace(/^#/, '')
      .trim();
  }

  function safeCssEscape(name) {
    // CSS.escape 미지원 브라우저 대비(최소 방어)
    if (w.CSS && typeof w.CSS.escape === 'function') return w.CSS.escape(name);
    return String(name).replace(/"/g, '\\"');
  }

  function ensureLoaded(img) {
    return new Promise(function (resolve) {
      if (img.complete && img.naturalWidth) return resolve();
      var done = function () {
        img.removeEventListener('load', done);
        img.removeEventListener('error', done);
        resolve();
      };
      img.addEventListener('load', done);
      img.addEventListener('error', done);
    });
  }

  function getNaturalSize(img) {
    var attrW = img.getAttribute('width');
    var attrH = img.getAttribute('height');

    var w0 = attrW ? Number(attrW) : 0;
    var h0 = attrH ? Number(attrH) : 0;

    if (!w0) w0 = img.naturalWidth || 0;
    if (!h0) h0 = img.naturalHeight || 0;

    return { w: w0, h: h0 };
  }

  function recalcOne(img) {
    var usemap = img.getAttribute('usemap');
    if (!usemap) return;

    var mapName = getMapName(usemap);
    if (!mapName) return;

    var mapEl = d.querySelector('map[name="' + safeCssEscape(mapName) + '"]');
    if (!mapEl) return;

    var ns = getNaturalSize(img);
    if (!ns.w || !ns.h) return;

    var displayW = img.clientWidth;
    var displayH = img.clientHeight;
    if (!displayW || !displayH) return;

    var areas = mapEl.querySelectorAll('area[coords]');
    for (var i = 0; i < areas.length; i++) {
      var area = areas[i];
      if (!area.dataset.rwdCoords) {
        area.dataset.rwdCoords = area.getAttribute('coords') || '';
      }

      var original = area.dataset.rwdCoords;
      if (!original) continue;

      var coords = parseCoords(original);
      if (!coords.length) continue;

      var scaled = new Array(coords.length);
      for (var j = 0; j < coords.length; j++) {
        var val = coords[j];
        if (j % 2 === 0) {
          // x
          scaled[j] = Math.round((val / ns.w) * displayW);
        } else {
          // y
          scaled[j] = Math.round((val / ns.h) * displayH);
        }
      }

      area.setAttribute('coords', scaled.join(','));
    }
  }

  async function recalcAll(images) {
    var list;
    if (!images) {
      list = Array.prototype.slice.call(d.querySelectorAll('img[usemap]'));
    } else if (typeof images === 'string') {
      list = Array.prototype.slice.call(d.querySelectorAll(images));
    } else if (images instanceof Element) {
      list = [images];
    } else {
      list = Array.prototype.slice.call(images);
    }

    for (var i = 0; i < list.length; i++) {
      var img = list[i];
      if (!img || !img.getAttribute) continue;
      await ensureLoaded(img);
      recalcOne(img);
    }
  }

  // ✅ 전역 함수명: rwdImg
  w.rwdImg = function (imagesOrSelector) {
    // 최초 1회
    recalcAll(imagesOrSelector);

    // resize 재계산 (디바운스)
    var onResize = debounce(function () {
      recalcAll(imagesOrSelector);
    }, 50);

    w.addEventListener('resize', onResize);

    // destroy 반환
    return function destroy() {
      w.removeEventListener('resize', onResize);
    };
  };
})(window, document);
